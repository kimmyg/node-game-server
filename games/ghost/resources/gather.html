<!DOCTYPE html>
<html>

<head>
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1"/>
<link rel="stylesheet" href="style.css" type="text/css"/>
<script type="text/javascript" src="/js/prelude.js"></script>
<script type="text/javascript" src="/js/player-list.js"></script>
<script type="text/javascript" src="/js/chat.js"></script>
<script type="text/javascript">
var createLeaveButtonElement = function() {
	var element = document.createElement( 'button' );
	
	element.id = 'leave-button';
	element.innerText = 'Leave';
	
	return element;
}

var createStartButtonElement = function() {
	var element = document.createElement( 'button' );
	
	element.id = 'start-button';
	element.innerText = 'Start';
	
	return element;
}

var removeStartButton = function() {
	var start_button = $('start-button');
	
	if( start_button ) {
		start_button.parentElement.removeChild( start_button );
	}
}

window.onload = function( event ) {
	var player_list = new PlayerList( 'player-list' );
	$('main').appendChild( player_list.createElement() );
	
	var chat = new Chat( 'chat' );
	$('main').appendChild( chat.createElement() );
	
	$('main').appendChild( createLeaveButtonElement() );

	var ws = new WebSocket( 'ws://' + location.host + location.pathname );

	//ws.onopen = function( event ) {}

	ws.onmessage = function( event ) {
		var message = JSON.parse( event.data );
		
		console.log( message );

		if( message.type === 'game-allow-start' ) {
			var start_button = createStartButtonElement();
			
			start_button.onclick = function( event ) {
				ws.send( JSON.stringify({ type: 'start' }) );
			};
		
			$('main').appendChild( start_button );
		}
		else if( message.type === 'game-revoke-start' ) {
			removeStartButton();
		}
		else if( message.type === 'player-list' ) {
			for( var i = 0; i < message.players.length; ++i ) {
				player_list.add( message.players[i] );
			}
		}
		else if( message.type === 'player-add' ) {
			player_list.add( message.player_name );
		}
		else if( message.type === 'player-remove' ) {
			player_list.remove( message.player_name );
		}
		else if( message.type === 'chat' ) {
			chat.addMessage( message.sender, message.message );
		}
		else if( message.type === 'chat-compose-start' ) {
			chat.composeStart( message.sender );
		}
		else if( message.type === 'chat-compose-cancel' ) {
			chat.composeCancel( message.sender );
		}
		else if( message.type === 'start' ) {
			window.location.reload();
		}
		else {
			console.log( 'unrecognized message type ' + message.type );
		}

	};

	//ws.onclose = function( event ) {}
	//ws.onerror = function( event ) {}
	
	chat.on_message_send = function( message ) {
		ws.send( JSON.stringify({ type: 'chat', message: message }) );
	};
	
	chat.on_compose_start = function() {
		ws.send( JSON.stringify({ type: 'chat-compose-start' }) );
	};
	
	chat.on_compose_cancel = function() {
		ws.send( JSON.stringify({ type: 'chat-compose-cancel' }) );
	};
	
	$('leave-button').onclick = function( event ) { // change to shake to leave for consistency?
		if( confirm( 'Leave this gathering?' ) ) {
			window.location.href = '/ghost/'; // make extensible somehow, abstract
		}
	};	
};
</script>
</head>

<body id="main">
</body>

</html>
